<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Добавление сотрудников и услуг</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
</head>
<body>
<div class="container py-4">
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <b>Инструкция:</b>
                <a href="/logout" class="btn btn-outline-danger btn-sm">Выйти</a>
            </div>
            <ul class="mb-0">
                <li>Заполните данные сотрудника и/или услуги.</li>
                <li>После добавления, проверьте работу Telegram-бота.</li>
                <li>Если бот видит новые данные — всё работает!</li>
            </ul>
        </div>
    </div>
    {% if messages %}
    {% for category, msg in messages %}
    <div class="alert {% if category == 'success' %}alert-success{% else %}alert-danger{% endif %} alert-dismissible fade show"
         role="alert">
        {{ msg }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
    </div>
    {% endfor %}
    {% endif %}
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">Добавить сотрудника</div>
                <div class="card-body">
                    <form id="add-cooperator-form" method="post" action="/add_cooperator">
                        <div class="mb-3">
                            <input type="number" name="id" class="form-control" placeholder="ID сотрудника" required>
                        </div>
                        <div class="mb-3">
                            <input list="branch-list-coop" type="number" name="branch_id" class="form-control" placeholder="ID филиала" required>
                            <datalist id="branch-list-coop">
                                {% set branches = cooperators | map(attribute='branch_id') | list %}
                                {% for branch_id in branches[:5] %}
                                <option value="{{ branch_id }}">{{ branch_id }}</option>
                                {% endfor %}
                            </datalist>
                        </div>
                        <div class="mb-3">
                            <input list="cooperator-list" type="text" name="name" class="form-control" placeholder="Имя сотрудника" required>
                            <datalist id="cooperator-list">
                                {% for c in cooperators[:5] %}
                                <option value="{{ c.name }}">{{ c.name }}</option>
                                {% endfor %}
                            </datalist>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Добавить</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">Добавить услугу</div>
                <div class="card-body">
                    <form id="add-service-form" method="post" action="/add_service">
                        <div class="mb-3">
                            <input type="number" name="id" class="form-control" placeholder="ID услуги" required>
                        </div>
                        <div class="mb-3">
                            <input list="branch-list-serv" type="number" name="branch_id" class="form-control" placeholder="ID филиала" required>
                            <datalist id="branch-list-serv">
                                {% set branches = services | map(attribute='branch_id') | list %}
                                {% for branch_id in branches[:5] %}
                                <option value="{{ branch_id }}">{{ branch_id }}</option>
                                {% endfor %}
                            </datalist>
                        </div>
                        <div class="mb-3">
                            <input list="cooperator-id-list" type="number" name="cooperator_id" class="form-control" placeholder="ID сотрудника" required>
                            <datalist id="cooperator-id-list">
                                {% set coop_ids = services | map(attribute='cooperator_id') | list %}
                                {% for coop_id in coop_ids[:5] %}
                                <option value="{{ coop_id }}">{{ coop_id }}</option>
                                {% endfor %}
                            </datalist>
                        </div>
                        <div class="mb-3">
                            <input list="service-list" type="text" name="name" class="form-control" placeholder="Название услуги" required>
                            <datalist id="service-list">
                                {% for s in services[:5] %}
                                <option value="{{ s.name }}">{{ s.name }}</option>
                                {% endfor %}
                            </datalist>
                        </div>
                        <div class="mb-3">
                            <input type="number" step="0.01" name="price" class="form-control" placeholder="Цена" required>
                        </div>
                        <div class="mb-3">
                            <input type="number" name="duration" class="form-control" placeholder="Длительность (минуты)" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Добавить</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
<script>
window.data = {
    cooperator_id_names: {{ cooperator_id_names | tojson }},
    cooperator_branch_ids: {{ cooperators | map(attribute='branch_id') | list | tojson }},
    cooperator_names: {{ cooperators | map(attribute='name') | list | tojson }},
    service_id_names: {{ service_id_names | tojson }},
    service_branch_ids: {{ services | map(attribute='branch_id') | list | tojson }},
    service_cooperator_ids: {{ services | map(attribute='cooperator_id') | list | tojson }},
    service_names: {{ services | map(attribute='name') | list | tojson }},
    service_prices: {{ services | map(attribute='price') | list | tojson }},
    service_durations: {{ services | map(attribute='duration') | list | tojson }}
};

// Функция для создания выпадающего списка
function attachDropdown(input, values, extractId = false) {
    let dropdown = document.createElement('div');
    dropdown.className = 'dropdown-menu show';
    dropdown.style.position = 'absolute';
    dropdown.style.zIndex = 1000;
    dropdown.style.width = input.offsetWidth + 'px';
    dropdown.style.maxHeight = '200px';
    dropdown.style.overflowY = 'auto';
    dropdown.style.display = 'none';
    dropdown.style.fontSize = '1rem';

    let page = 0;
    let filtered = values;

    function render() {
        dropdown.innerHTML = '';
        let pageSize = 5;
        let pageCount = Math.ceil(filtered.length / pageSize);
        let start = page * pageSize;
        let end = start + pageSize;
        let items = filtered.slice(start, end);
        items.forEach(val => {
            let item = document.createElement('button');
            item.type = 'button';
            item.className = 'dropdown-item';
            item.textContent = val;
            item.onclick = () => {
                if (extractId) {
                    input.value = val.split('|')[0].trim();
                } else {
                    input.value = val;
                }
                dropdown.style.display = 'none';
            };
            dropdown.appendChild(item);
        });
        if (pageCount > 1) {
            let nav = document.createElement('div');
            nav.className = 'd-flex justify-content-between px-2 py-1';
            let prev = document.createElement('button');
            prev.type = 'button';
            prev.className = 'btn btn-sm btn-light';
            prev.textContent = '↑';
            prev.disabled = page === 0;
            prev.onclick = () => { page--; render(); };
            let next = document.createElement('button');
            next.type = 'button';
            next.className = 'btn btn-sm btn-light';
            next.textContent = '↓';
            next.disabled = page >= pageCount - 1;
            next.onclick = () => { page++; render(); };
            nav.appendChild(prev);
            nav.appendChild(next);
            dropdown.appendChild(nav);
        }
        if (filtered.length === 0) {
            let empty = document.createElement('div');
            empty.className = 'dropdown-item text-muted';
            empty.textContent = 'Нет совпадений';
            dropdown.appendChild(empty);
        }
    }

    input.parentNode.appendChild(dropdown);

    input.addEventListener('focus', () => {
        filtered = values;
        page = 0;
        render();
        dropdown.style.display = 'block';
        positionDropdown();
    });

    input.addEventListener('input', () => {
        let val = input.value.toLowerCase();
        filtered = values.filter(v => v.toString().toLowerCase().startsWith(val));
        page = 0;
        render();
        dropdown.style.display = filtered.length > 0 ? 'block' : 'none';
        positionDropdown();
    });

    input.addEventListener('blur', () => {
        setTimeout(() => dropdown.style.display = 'none', 150);
    });

    function positionDropdown() {
        let rect = input.getBoundingClientRect();
        dropdown.style.top = (input.offsetTop + input.offsetHeight) + 'px';
        dropdown.style.left = input.offsetLeft + 'px';
    }
}

// Привязка dropdown к каждому полю
window.addEventListener('DOMContentLoaded', () => {
    // Сотрудник
    const coopForm = document.getElementById('add-cooperator-form');
    attachDropdown(coopForm.querySelector('input[name="id"]'), window.data.cooperator_id_names, true); // extractId=true
    attachDropdown(coopForm.querySelector('input[name="branch_id"]'), window.data.cooperator_branch_ids);
    attachDropdown(coopForm.querySelector('input[name="name"]'), window.data.cooperator_names);

    // Услуга
    const servForm = document.getElementById('add-service-form');
    attachDropdown(servForm.querySelector('input[name="id"]'), window.data.service_id_names, true); // extractId=true
    attachDropdown(servForm.querySelector('input[name="branch_id"]'), window.data.service_branch_ids);
    attachDropdown(servForm.querySelector('input[name="cooperator_id"]'), window.data.cooperator_id_names, true); // extractId=true
    attachDropdown(servForm.querySelector('input[name="name"]'), window.data.service_names);
    attachDropdown(servForm.querySelector('input[name="price"]'), window.data.service_prices);
    attachDropdown(servForm.querySelector('input[name="duration"]'), window.data.service_durations);
});
</script>
</body>
</html>